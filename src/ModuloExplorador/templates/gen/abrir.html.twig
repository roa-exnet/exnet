{% extends 'base.html.twig' %}
{% block title %}{{ filename }} - Explorador Exnet{% endblock %}

{% block head %}
{{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/explorer/css/explorer.css') }}">
{% endblock %}

{% block body %}
<div class="exnet-container-transparent p-4">
    <!-- Cabecera con título y botones -->
    <div class="file-header d-flex justify-content-between align-items-center mb-4">
        <h1 class="exnet-main-title">{{ filename }}</h1>
        <div class="file-actions-buttons">
            <a href="{{ path('explorer') }}" class="file-action-btn btn-back">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
            <form action="{{ path('download') }}" method="POST" class="d-inline">
                <input type="hidden" name="file_path" value="{{ directory ~ '/' ~ filename }}">
                <button type="submit" class="file-action-btn btn-download">
                    <i class="fas fa-download"></i> Descargar
                </button>
            </form>
        </div>
    </div>

    <!-- Información del archivo y visor -->
    <div class="file-content-container">
        <!-- Panel de metadatos del archivo -->
        <div class="file-info-panel">
            <div class="file-info-item">
                <div class="info-label">Ubicación:</div>
                <div class="info-value">{{ directory }}</div>
            </div>
        </div>

        <!-- Contenido del archivo -->
        <div class="file-viewer">
            {% if isImage %}
                <div class="image-preview">
                    <div class="loader" id="imageLoader">
                        <div class="loader-spinner"></div>
                        <div class="loader-text">Cargando imagen...</div>
                    </div>
                    <iframe id="imageIframe" width="100%" height="600px" frameborder="0" style="overflow:hidden; border:none; background-color: rgba(0,0,0,0.2);" onerror="handleImageError()"></iframe>
                </div>
            {% elseif isVideo %}
                <div class="video-preview">
                    <iframe src="{{ path('ver_video', { 'filename': filename, 'path': directory }) }}" width="100%" height="600px" frameborder="0" allowfullscreen></iframe>
                </div>
            {% else %}
                <div class="text-preview">
                    <pre class="text-content">{{ fileContent }}</pre>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Función para cargar la imagen
    function cargarImagen() {
        var filename = "{{ filename }}";
        var directory = "{{ directory }}";
        var loader = document.getElementById('imageLoader');
        
        if (loader) {
            loader.style.display = 'flex';
        }
        
        // Hacer la solicitud POST
        fetch("{{ path('ver_imagen') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                'filename': filename,
                'path': directory
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor: ' + response.status);
            }
            return response.blob();
        })
        .then(imageBlob => {
            var img = URL.createObjectURL(imageBlob);
            document.getElementById('imageIframe').src = img;
            if (loader) {
                loader.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error cargando la imagen:', error);
            if (loader) {
                loader.querySelector('.loader-spinner').style.display = 'none';
                loader.querySelector('.loader-text').textContent = 'Error al cargar la imagen. Intente nuevamente.';
            }
        });
    }
    
    // Función que maneja el error al cargar la imagen en el iframe
    function handleImageError() {
        console.log('Error al cargar la imagen en el iframe.');
        var loader = document.getElementById('imageLoader');
        if (loader) {
            loader.querySelector('.loader-spinner').style.display = 'none';
            loader.querySelector('.loader-text').textContent = 'Error al cargar la imagen. Intente nuevamente.';
            loader.style.display = 'flex';
        }
    }

    // Ejecutar la función de carga de imagen al cargar la página
    document.addEventListener('DOMContentLoaded', cargarImagen);
</script>
{% endblock %}